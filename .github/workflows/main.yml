name: Discord Notifications

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed, reopened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Discord Embed JSON
        id: generate_embed
        run: |
          EVENT_NAME="${{ github.event_name }}"
          REPOSITORY="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP="${{ github.event.repository.updated_at }}"

          # Customize the message based on the event type
          if [[ "$EVENT_NAME" == "push" ]]; then
            DESCRIPTION="üì• New push to repository: $REPOSITORY"
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            DESCRIPTION="üîÄ Pull request ${{ github.event.action }}: ${{ github.event.pull_request.title }}"
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            DESCRIPTION="‚ö†Ô∏è Issue ${{ github.event.action }}: ${{ github.event.issue.title }}"
          else
            DESCRIPTION="‚ÑπÔ∏è Event '$EVENT_NAME' occurred in repository: $REPOSITORY"
          fi

          # Generate the JSON payload
          EMBED_JSON=$(jq -n \
            --arg title "Repository Update" \
            --arg description "$DESCRIPTION" \
            --arg color "5814783" \
            --arg eventType "$EVENT_NAME" \
            --arg repository "$REPOSITORY" \
            --arg triggeredBy "$ACTOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    {
                      name: "Event Type",
                      value: $eventType,
                      inline: true
                    },
                    {
                      name: "Repository",
                      value: $repository,
                      inline: true
                    },
                    {
                      name: "Triggered By",
                      value: $triggeredBy,
                      inline: true
                    }
                  ],
                  footer: {
                    text: "GitHub Actions"
                  },
                  timestamp: $timestamp
                }
              ]
            }')

          # Output the JSON for the next step
          echo "::set-output name=embed_json::$EMBED_JSON"

      - name: Send Discord Notification
        uses: Ilshidur/action-discord@master
        with:
          args: '${{ steps.generate_embed.outputs.embed_json }}'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
