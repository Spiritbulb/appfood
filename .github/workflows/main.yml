name: Discord Notifications

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed, reopened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Discord Payload
        id: generate_payload
        run: |
          EVENT_NAME="${{ github.event_name }}"
          REPOSITORY="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          # Customize the message based on the event type
          if [[ "$EVENT_NAME" == "push" ]]; then
            DESCRIPTION="📥 New push to repository: $REPOSITORY"
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            DESCRIPTION="🔀 Pull request ${{ github.event.action }}: ${{ github.event.pull_request.title }}"
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            DESCRIPTION="⚠️ Issue ${{ github.event.action }}: ${{ github.event.issue.title }}"
          else
            DESCRIPTION="ℹ️ Event '$EVENT_NAME' occurred in repository: $REPOSITORY"
          fi

          # Generate the JSON payload
          PAYLOAD=$(jq -n \
            --arg title "Repository Update" \
            --arg description "$DESCRIPTION" \
            --arg color "5814783" \
            --arg eventType "$EVENT_NAME" \
            --arg repository "$REPOSITORY" \
            --arg triggeredBy "$ACTOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: ($color | tonumber),
                  fields: [
                    {
                      name: "Event Type",
                      value: $eventType,
                      inline: true
                    },
                    {
                      name: "Repository",
                      value: $repository,
                      inline: true
                    },
                    {
                      name: "Triggered By",
                      value: $triggeredBy,
                      inline: true
                    }
                  ],
                  footer: {
                    text: "GitHub Actions"
                  },
                  timestamp: $timestamp
                }
              ]
            }')

          # Output the JSON for debugging
          echo "Generated Payload:"
          echo "$PAYLOAD"

          # Set the payload as an output for the next step
          echo "payload=$PAYLOAD" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '${{ steps.generate_payload.outputs.payload }}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
